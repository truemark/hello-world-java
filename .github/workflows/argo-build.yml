name: ArgoCD Demo

on:
  workflow_call:

permissions:
  id-token: write
  contents: write

jobs:
  build-maven:
    name: Build Maven
    uses: truemark/github-workflows/.github/workflows/build-maven.yml@argocd-demo
    with:
      version: 61.${{ github.run_number }}.${{ github.run_attempt }}
      java_version: 21
      java_distribution: "corretto"

  build-docker:
    name: Build Docker
    uses: truemark/github-workflows/.github/workflows/build-docker.yml@argocd-demo
    if: github.ref == 'refs/heads/argocd-demo-louie'
    with:
      version: 61.${{ github.run_number }}.${{ github.run_attempt }}
      image_name: "truemark/helloworld-java"
      aws_region: "us-east-1"
    secrets:
      aws_assume_role: ${{ secrets.AWS_ASSUME_ROLE }}
      docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
      docker_hub_password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
    needs: [build-maven]

  eks-deploy-prod:
    if: github.ref == 'refs/heads/argocd-demo-louie'
    name: Deploy using ArgoCD
    uses: truemark/github-workflows/.github/workflows/argo-deploy.yml@argocd-demo
    with:
      helm_chart_path: "helm-chart/hello-world"
      github_user: "GitHub Actions"
      github_email: "actions@github.com"
    needs: [build-docker]

name: Values Only Deployment

on:
  push:
    paths:
      - 'kubernetes/**'
  workflow_dispatch:

permissions:
  id-token: write
  contents: write

jobs:
  values-update:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-environment.outputs.environment }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Environment
        id: set-environment
        run: |
          UPDATED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          echo "Updated files: $UPDATED_FILES"
          
          if echo "$UPDATED_FILES" | grep -q "kubernetes/prod/values.yaml"; then
            echo "environment=prod" >> $GITHUB_ENV
            echo "::set-output name=environment::prod"
          elif echo "$UPDATED_FILES" | grep -q "kubernetes/stage/values.yaml"; then
            echo "environment=stage" >> $GITHUB_ENV
            echo "::set-output name=environment::stage"
          else
            echo "No matching environment file found"
            exit 1
          fi
          echo "APP_NAME=hello-world" >> $GITHUB_ENV

      - name: Install Kubectl and YQ
        uses: truemark/kubectl-action@converting-to-typescript
        with:
          yq-enabled: true
          kubectl-enabled: true

      - name: Generate token
        id: app-token
        uses: getsentry/action-github-app-token@v3
        with:
          app_id: ${{ secrets.RELEASE_BOT_ID }}
          private_key: ${{ secrets.RELEASE_BOT_KEY }}

      - name: Checkout Deployment Repo
        uses: actions/checkout@v4
        with:
          repository: truemark/k8s-deployments
          token: ${{ steps.app-token.outputs.token }}
          path: k8s-deployments

      - name: Copy Updates to Deployment Repo
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
          APP_NAME: ${{ env.APP_NAME }}
          UPDATED_FILES: ${{ env.UPDATED_FILES }}
        run: |
          cp $UPDATED_FILE k8s-deployments/environments/${{ env.ENVIRONMENT }}/${{ env.APP_NAME }}/
          cd k8s-deployments
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add environments/${{ env.ENVIRONMENT }}/${{ env.APP_NAME }}/$(basename ${{ env.UPDATED_FILES }})
          git commit -m "Update deployment values for ${{ env.ENVIRONMENT }} from ${{ env.UPDATED_FILES }}"
          git push origin main

      - name: Upload Environment Artifact
        uses: actions/upload-artifact@v4
        with:
          name: environment
          path: environment.txt
